# =============================================================================
# Terraform Bootstrap Backend - DESTROY (manual, no safeguard)
#
# Purpose:
#   Destroys ONLY the Terraform *bootstrap backend* resources defined under:
#       terraform/bootstrap-backend
#
# Why this exists:
#   Bootstrap backend resources are foundational (state storage account, container,
#   resource group, etc.). This workflow provides an explicit, standalone way to
#   delete those foundational resources when you truly mean it.
#
# Trigger:
#   Manual only (workflow_dispatch). You start it from the GitHub Actions UI.
#
# Behavior (IMPORTANT):
#   - Runs "terraform destroy -auto-approve" (fully non-interactive)
#   - No confirmation prompt / no secondary approval in workflow logic
#   - Any safety controls should be implemented via GitHub Environments,
#     branch protections, repo permissions, or optional workflow inputs.
#
# Authentication:
#   Uses Azure Service Principal + Client Secret stored in GitHub Environment
#   Secrets (Environment name: "AZURE"):
#     - AZURE_CLIENT_ID
#     - AZURE_CLIENT_SECRET
#     - AZURE_TENANT_ID
#     - AZURE_SUBSCRIPTION_ID
#
# Notes:
#   - Terraform automatically loads terraform.tfvars from WORKING_DIR.
#     So values like enable_rg_lock=false are applied automatically.
#   - If your bootstrap terraform creates an Azure RG delete lock, destroy can
#     fail with ScopeLocked errors. Your note implies enable_rg_lock=false to
#     avoid that (good).
#   - azure/login@v2 does NOT accept "client-secret:" as an input; for SP+secret
#     auth you must use the "creds" JSON object.
# =============================================================================

name: Terraform Bootstrap Backend - DESTROY (manual)

# -----------------------------------------------------------------------------
# Manual trigger ONLY.
# -----------------------------------------------------------------------------
on:
  workflow_dispatch: {}   # manual trigger only, no inputs
  schedule:
    # GitHub cron is UTC. 2:00 AM CST (UTC-6) = 08:00 UTC.
    - cron: "0 8 * * *"

permissions:
  contents: read

# -----------------------------------------------------------------------------
# Concurrency:
# Prevent apply/destroy from running at the same time.
# -----------------------------------------------------------------------------
concurrency:
  group: terraform-bootstrap
  cancel-in-progress: false

jobs:
  destroy:
    name: Destroy bootstrap backend
    runs-on: ubuntu-latest

    # -------------------------------------------------------------------------
    # Bind the GitHub Environment named "AZURE" to this job.
    # REQUIRED for Environment secrets to be injected.
    # -------------------------------------------------------------------------
    environment: AZURE

    env:
      # Terraform folder containing the bootstrap backend code + terraform.tfvars
      WORKING_DIR: terraform/bootstrap-backend

      # AzureRM provider authentication (Service Principal + Secret)
      # Terraform's AzureRM provider reads these automatically.
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Makes Terraform less interactive and more CI-friendly.
      TF_IN_AUTOMATION: "true"

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout repository content
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 1.5: Verify required secrets are present (fail fast)
      #
      # Why:
      #   - If Environment secrets aren't available, the ARM_* vars become empty.
      #   - This fails early with a clear message (no secret leakage).
      # -----------------------------------------------------------------------
      - name: Verify required secrets are present (no output)
        shell: bash
        run: |
          set -euo pipefail
          missing=0
          for v in ARM_CLIENT_ID ARM_CLIENT_SECRET ARM_TENANT_ID ARM_SUBSCRIPTION_ID; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required secret/env var: ${v}"
              missing=1
            fi
          done
          exit $missing

      # -----------------------------------------------------------------------
      # Step 2: Azure Login (Service Principal + Client Secret)
      #
      # Notes:
      #   - For azure/login@v2, SP+secret auth must be passed via "creds" JSON.
      # -----------------------------------------------------------------------
      - name: Azure Login (Service Principal Secret)
        uses: azure/login@v2
        with:
          auth-type: SERVICE_PRINCIPAL
          creds: >-
            {"clientId":"${{ secrets.AZURE_CLIENT_ID }}",
             "clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}",
             "tenantId":"${{ secrets.AZURE_TENANT_ID }}",
             "subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      # -----------------------------------------------------------------------
      # Step 3: Install Terraform CLI on the runner
      # -----------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.3"
          terraform_wrapper: false

      # -----------------------------------------------------------------------
      # Step 4: terraform init
      # -----------------------------------------------------------------------
      - name: Terraform init (bootstrap)
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init --upgrade

      # -----------------------------------------------------------------------
      # Step 5: terraform destroy
      # -----------------------------------------------------------------------
      - name: Terraform destroy (bootstrap)
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform destroy -auto-approve
