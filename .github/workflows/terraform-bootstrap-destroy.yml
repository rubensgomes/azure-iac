# =============================================================================
# Terraform Bootstrap Backend - DESTROY (manual, guarded)
#
# Purpose:
#   Destroys ONLY the Terraform *bootstrap backend* resources defined under:
#       terraform/bootstrap-backend
#
# Why this exists:
#   Bootstrap backend resources are foundational (state RG, storage account,
#   blob container, etc.). This workflow provides an explicit, standalone way
#   to delete those foundational resources when you truly mean it.
#
# Trigger:
#   Manual only (workflow_dispatch). You start it from the GitHub Actions UI.
#
# SAFEGUARD (IMPORTANT):
#   This workflow now enforces an explicit “question + response” safeguard:
#   - The workflow_dispatch form asks the user to type a specific phrase.
#   - The job fails immediately if the phrase does not match exactly.
#
# Authentication:
#   Uses Azure Service Principal + Client Secret stored in GitHub Environment
#   Secrets (Environment name: "AZURE"):
#     - AZURE_CLIENT_ID
#     - AZURE_CLIENT_SECRET
#     - AZURE_TENANT_ID
#     - AZURE_SUBSCRIPTION_ID
#
# Notes:
#   - Terraform automatically loads terraform.tfvars from WORKING_DIR.
#   - azure/login@v2 does NOT accept "client-secret:" as an input; for SP+secret
#     auth you must use the "creds" JSON object.
# =============================================================================

name: Terraform Bootstrap Backend - DESTROY (manual)

# -----------------------------------------------------------------------------
# Manual trigger ONLY, with safeguard inputs.
#
# The workflow UI will show these fields when you click "Run workflow".
# -----------------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: >
          SAFEGUARD QUESTION: Type EXACTLY the phrase below to confirm destruction:
          DESTROY rg-tfstate sttfstaterubens01 tfstate
        required: true
        type: string

      rg_name:
        description: "Target RG name (must match the expected bootstrap RG)"
        required: true
        default: "rg-tfstate"
        type: string

      storage_account_name:
        description: "Target Storage Account name (must match expected)"
        required: true
        default: "sttfstaterubens01"
        type: string

      container_name:
        description: "Target Container name (must match expected)"
        required: true
        default: "tfstate"
        type: string

# -----------------------------------------------------------------------------
# Permissions:
# contents:read is enough for checkout. Keep least privilege.
# -----------------------------------------------------------------------------
permissions:
  contents: read

# -----------------------------------------------------------------------------
# Concurrency:
# Prevent apply/destroy from running at the same time.
# -----------------------------------------------------------------------------
concurrency:
  group: terraform-bootstrap
  cancel-in-progress: false

jobs:
  destroy:
    name: Destroy bootstrap backend
    runs-on: ubuntu-latest

    # -------------------------------------------------------------------------
    # Bind the GitHub Environment named "AZURE" to this job.
    # REQUIRED for Environment secrets to be injected.
    # -------------------------------------------------------------------------
    environment: AZURE

    env:
      # -----------------------------------------------------------------------
      # Terraform folder containing the bootstrap backend code + terraform.tfvars
      # -----------------------------------------------------------------------
      WORKING_DIR: terraform/bootstrap-backend

      # -----------------------------------------------------------------------
      # AzureRM provider authentication (Service Principal + Secret)
      # Terraform's AzureRM provider reads these automatically.
      # -----------------------------------------------------------------------
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Makes Terraform less interactive and more CI-friendly.
      TF_IN_AUTOMATION: "true"

      # -----------------------------------------------------------------------
      # Bootstrap identifiers used both for documentation and safeguard validation.
      # IMPORTANT: Keep these in sync with your terraform/bootstrap-backend config.
      # -----------------------------------------------------------------------
      EXPECTED_RG_NAME: "rg-tfstate"
      EXPECTED_STORAGE_ACCOUNT_NAME: "sttfstaterubens01"
      EXPECTED_CONTAINER_NAME: "tfstate"

      # -----------------------------------------------------------------------
      # Optional hard lock: only allow a specific actor to run this workflow.
      # - This is extra defense-in-depth for public repos.
      # - If you ever rename your GitHub username, update this value.
      # -----------------------------------------------------------------------
      ALLOWED_ACTOR: "rubensgomes"

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout repository content
      #
      # Fetches the Terraform code in terraform/bootstrap-backend.
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: SAFEGUARD - Validate actor + typed confirmation + target fields
      #
      # Purpose:
      #   Ensures destructive operation is deliberate and aimed at the expected
      #   bootstrap resources.
      #
      # What it enforces:
      #   1) (Optional) Only ALLOWED_ACTOR may run this workflow
      #   2) rg_name / storage_account_name / container_name must match expected
      #   3) confirm input must EXACTLY match:
      #        "DESTROY <rg> <storage> <container>"
      #
      # Failure behavior:
      #   If any check fails, the workflow exits immediately before logging in
      #   or calling Terraform.
      # -----------------------------------------------------------------------
      - name: SAFEGUARD - Validate confirmation (type-to-confirm)
        shell: bash
        run: |
          set -euo pipefail

          # ---- (Optional) Actor allowlist gate ----
          # Comment this block out if you do NOT want actor restriction.
          if [ "${{ github.actor }}" != "${ALLOWED_ACTOR}" ]; then
            echo "Denied: Only '${ALLOWED_ACTOR}' may run this workflow."
            echo "Current actor: '${{ github.actor }}'"
            exit 1
          fi

          # ---- Validate target identifiers match expected ----
          if [ "${{ github.event.inputs.rg_name }}" != "${EXPECTED_RG_NAME}" ]; then
            echo "Denied: rg_name mismatch."
            echo "Expected: '${EXPECTED_RG_NAME}'"
            echo "Got:      '${{ github.event.inputs.rg_name }}'"
            exit 1
          fi

          if [ "${{ github.event.inputs.storage_account_name }}" != "${EXPECTED_STORAGE_ACCOUNT_NAME}" ]; then
            echo "Denied: storage_account_name mismatch."
            echo "Expected: '${EXPECTED_STORAGE_ACCOUNT_NAME}'"
            echo "Got:      '${{ github.event.inputs.storage_account_name }}'"
            exit 1
          fi

          if [ "${{ github.event.inputs.container_name }}" != "${EXPECTED_CONTAINER_NAME}" ]; then
            echo "Denied: container_name mismatch."
            echo "Expected: '${EXPECTED_CONTAINER_NAME}'"
            echo "Got:      '${{ github.event.inputs.container_name }}'"
            exit 1
          fi

          # ---- Validate type-to-confirm phrase ----
          expected="DESTROY ${EXPECTED_RG_NAME} ${EXPECTED_STORAGE_ACCOUNT_NAME} ${EXPECTED_CONTAINER_NAME}"
          if [ "${{ github.event.inputs.confirm }}" != "${expected}" ]; then
            echo "Denied: Confirmation phrase did not match exactly."
            echo "Expected: ${expected}"
            echo "Got:      ${{ github.event.inputs.confirm }}"
            exit 1
          fi

          echo "Safeguard passed. Proceeding with destroy."

      # -----------------------------------------------------------------------
      # Step 3: Verify required secrets are present (fail fast)
      #
      # Purpose:
      #   Ensures Environment secrets actually resolved into ARM_* variables.
      #   If any are missing, fail before attempting Azure login or Terraform.
      #
      # Security:
      #   Does not print secret values (only variable names).
      # -----------------------------------------------------------------------
      - name: Verify required secrets are present (no output)
        shell: bash
        run: |
          set -euo pipefail
          missing=0
          for v in ARM_CLIENT_ID ARM_CLIENT_SECRET ARM_TENANT_ID ARM_SUBSCRIPTION_ID; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required secret/env var: ${v}"
              missing=1
            fi
          done
          exit $missing

      # -----------------------------------------------------------------------
      # Step 4: Azure Login (Service Principal + Client Secret)
      #
      # Notes:
      #   - azure/login@v2 expects SP+secret auth via the "creds" JSON payload.
      #   - We explicitly set auth-type=SERVICE_PRINCIPAL.
      # -----------------------------------------------------------------------
      - name: Azure Login (Service Principal Secret)
        uses: azure/login@v2
        with:
          auth-type: SERVICE_PRINCIPAL
          creds: >-
            {"clientId":"${{ secrets.AZURE_CLIENT_ID }}",
             "clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}",
             "tenantId":"${{ secrets.AZURE_TENANT_ID }}",
             "subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      # -----------------------------------------------------------------------
      # Step 5: Install Terraform CLI on the runner
      #
      # Notes:
      #   - Keep version pinned to match your validated version.
      #   - terraform_wrapper=false keeps logs simpler/cleaner.
      # -----------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.3"
          terraform_wrapper: false

      # -----------------------------------------------------------------------
      # Step 6: terraform init
      #
      # Purpose:
      #   Initializes providers and state so Terraform can destroy correctly.
      # -----------------------------------------------------------------------
      - name: Terraform init (bootstrap)
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init --upgrade

      # -----------------------------------------------------------------------
      # Step 7: terraform import bootstrap backend state (optional)
      #
      # Purpose:
      #   If resources were created previously outside this runner’s state,
      #   import-state can align state with reality before destruction.
      #
      # Note:
      #   This assumes you have a local composite action at:
      #     ./.github/actions/import-state
      # -----------------------------------------------------------------------
      - name: Terraform import backend state (bootstrap)
        uses: ./.github/actions/import-state

      # -----------------------------------------------------------------------
      # Step 8: terraform destroy
      #
      # WARNING:
      #   This permanently deletes the bootstrap backend resources.
      #
      # -auto-approve:
      #   Non-interactive destroy. The safeguard above is your human confirmation.
      # -----------------------------------------------------------------------
      - name: Terraform destroy (bootstrap)
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform destroy -auto-approve

      # -----------------------------------------------------------------------
      # Step 9: Capture and save Terraform error output for later view.
      # -----------------------------------------------------------------------
      - name: Upload errored.tfstate if present
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: errored-tfstate
          path: errored.tfstate
          if-no-files-found: ignore
